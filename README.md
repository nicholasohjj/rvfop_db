## Database Diagram for RVRC FOP 2024 Dashboard

![Database Diagram](/images/database_diagram.png)


# **Database Overview**

This documentation provides a comprehensive overview of the schema, tables, and functions designed for managing a system of houses, groups, activities, group activities, deductions, and profiles. It outlines the relationships between these entities, permissions, and triggers implemented to ensure data integrity and automate data management.

## **Tables**

### **Houses**

- **Description**: Represents houses, each identified by a unique ID. Houses accumulate points and have a unique name.
- **Columns**:
    - **`house_id`**: Primary key, UUID generated by default.
    - **`name`**: Unique name of the house.
    - **`total_points`**: Total points accumulated by the house.

### **Groups**

- **Description**: Represents groups belonging to houses. Groups have their unique ID, name, and associated house, and they accumulate points.
- **Columns**:
    - **`group_id`**: Primary key, UUID generated by default.
    - **`name`**: Unique name of the group.
    - **`house_id`**: Foreign key linking to the **`houses`** table.
    - **`total_points`**: Total points accumulated by the group.
    - **`isprohuman`**: A boolean flag indicating a specific attribute of the group.

### **Activities**

- **Description**: Represents activities that can be undertaken by groups. Each activity has a unique ID, name, and associated points.
- **Columns**:
    - **`activity_id`**: Primary key, UUID generated by default.
    - **`name`**: Unique name of the activity.
    - **`points`**: Points associated with the activity, must be non-negative.
    - **`description`**: Textual description of the activity.

### **GroupActivities**

- **Description**: Associates activities with groups, recording completion status, points earned, and creation time.
- **Columns**:
    - **`group_activity_id`**: Primary key, UUID generated by default.
    - **`group_id`**: Foreign key linking to the **`groups`** table.
    - **`activity_id`**: Foreign key linking to the **`activities`** table.
    - **`completion_status`**: Indicates if the activity was completed.
    - **`points_earned`**: Points earned from the activity.
    - **`tm_created`**: Timestamp of record creation, adjusted to a specific timezone.

### **Deductions**

- **Description**: Records points deductions between groups, identified by a unique ID. Includes the amount deducted, the responsible group, and the timestamp.
- **Columns**:
    - **`deduction_id`**: Primary key, UUID generated by default.
    - **`group_id`**: Foreign key indicating the group from which points are deducted.
    - **`deductor_id`**: Foreign key indicating the group responsible for the deduction.
    - **`points_deducted`**: The amount of points deducted, must be non-positive.
    - **`tm_created`**: Timestamp of the deduction.
    - **`name`**: Name or reason for the deduction.

### **Profiles**

- **Description**: Represents user profiles, linking users to houses and groups.
- **Columns**:
    - **`id`**: Primary key, UUID.
    - **`email`**: User's email address.
    - **`house_id`**: Foreign key linking to the **`houses`** table.
    - **`group_id`**: Foreign key linking to the **`groups`** table.

## **Functions and Triggers**

### **Handle New User**

- **Functionality**: Automates the insertion of a new user profile upon user creation.

### **Update Points After Activity**

- **Functionality**: Automatically updates the points total for both groups and houses after an activity is recorded.

### **Check IsProHuman**

- **Functionality**: Validates conditions based on the **`isprohuman`** attribute before allowing deductions between groups.

### **Update Points After Deduction**

- **Functionality**: Adjusts the points total for groups involved in a deduction after the deduction record is created or updated.

## **Permissions**

- **Scope**: Applies to all tables.
- **Details**: Grants permissions for **`delete`**, **`insert`**, **`references`**, **`select`**, **`trigger`**, **`truncate`**, and **`update`** operations to roles **`anon`**, **`authenticated`**, and **`service_role`**.

## **Policies**

- **Profiles Table**: Implements policies to ensure users can view all profiles, insert their own profile, and update their own profile based on their user ID.

## **Ownership**

- **All Tables and Functions**: Ownership is assigned to the **`postgres`** user, ensuring administrative control over the database schema and logic.

